[gcode_macro MPC_CALIBRATE_BED]
description: Bed MPC Calibrate
gcode:
  {% set _ = params.BED_TEMP|default(90) %}
  {% set _ = params.FAN_BREAKPOINTS|default(10) %}
  MPC_CALIBRATE HEATER=heater_bed TARGET={params.BED_TEMP|default(80)} FAN_BREAKPOINTS={params.FAN_BREAKPOINTS|default(10)}

[gcode_macro MPC_CALIBRATE_HOTEND]
description: Hotend MPC Calibrate
gcode:
  {% set _ = params.HOTEND_TEMP|default(260) %}
  {% set _ = params.FAN_BREAKPOINTS|default(10) %}
  MPC_CALIBRATE HEATER=extruder TARGET={params.HOTEND_TEMP|default(260)} FAN_BREAKPOINTS={params.FAN_BREAKPOINTS|default(10)}

[gcode_macro Z_TILT]
description: "Performs Z Tilt Adjust"
gcode:
    G28
    Z_TILT_ADJUST
    _POST_HOME_XY
    G28 Z
    RESPOND TYPE=command MSG='Z Tilt Adjust complete!'

[delayed_gcode STARTUP]
initial_duration: 1
gcode:
  UNSYNC_ALL_TOOLS
  SYNC_LAST_TOOL
  PROBE_UP
  SET_PIN PIN=LED VALUE=1

[gcode_macro M109] # Wait Hotend Temp
rename_existing: M109.1
gcode:
    #Parameters
    {% set s = params.S|float %}

    M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}  # Set hotend temp
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s-2} MAXIMUM={s+5}   # Wait for hotend temp (within n degrees)
    {% endif %}

[gcode_macro M190] # Wait Bed Temp
rename_existing: M190.1
gcode:
    #Parameters
    {% set s = params.S|float %}

    M140 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}   # Set bed temp
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s-2} MAXIMUM={s+5}  # Wait for bed temp (within n degrees)
    {% endif %}

[gcode_macro _SET_MPC_MATERIAL]
description: Set heater MPC parameters for a given material
variable_filament_table:
    ## Update this table to adjust material settings
    {
        ## ( density, heat capacity )  # suggested heat capacity range
        "PLA"       : ( 1.25, 2.20 ),  # 1.80 - 2.20
        "PETG"      : ( 1.27, 2.20 ),  # 1.70 - 2.20
        "PC+ABS"    : ( 1.15, 2.20 ),  # 1.50 - 2.20
        "ABS"       : ( 1.06, 2.40 ),  # 1.25 - 2.40
        "ASA"       : ( 1.07, 2.10 ),  # 1.30 - 2.10
        "PA6"       : ( 1.12, 2.50 ),  # 2.00 - 2.50
        "PA"        : ( 1.15, 2.50 ),  # 2.00 - 2.50
        "PC"        : ( 1.20, 1.90 ),  # 1.10 - 1.90
        "TPU"       : ( 1.21, 2.00 ),  # 1.50 - 2.00
        "TPU-90A"   : ( 1.15, 2.00 ),  # 1.50 - 2.00
        "TPU-95A"   : ( 1.22, 2.00 ),  # 1.50 - 2.00
        "ABS-CF"    : ( 1.11, 2.40 ),  # 1.25 - 2.40
        "ASA-CF"    : ( 1.11, 2.10 ),  # 1.30 - 2.10
        "PA6-CF"    : ( 1.19, 2.50 ),  # 2.00 - 2.50
        "PC+ABS-CF" : ( 1.22, 2.20 ),  # 1.50 - 2.20
        "PC+CF"     : ( 1.36, 1.90 ),  # 1.10 - 1.90
        "PLA-CF"    : ( 1.29, 2.20 ),  # 1.80 - 2.20
        "PETG-CF"   : ( 1.30, 2.20 ),  # 1.70 - 2.20
    }
gcode:
    {% set material = params.MATERIAL | upper %}
    {% set heater = params.HEATER | default('extruder') %}
    {% set extruder_config = printer.configfile.settings[heater] %}

    {% if material in filament_table %}
        {% set (density, heat_capacity) = filament_table[material] %}

        RESPOND PREFIX=üî• MSG="Configured {heater} MPC for {material}. Density: {density}, Heat Capacity: {heat_capacity}"
    {% else %}
        {% set density = extruder_config.filament_density %}
        {% set heat_capacity=extruder_config.filament_heat_capacity %}

        RESPOND PREFIX=üî• MSG="Unknown material '{material}', using default mpc parameters for {heater}"
    {% endif %}

    MPC_SET HEATER={heater} FILAMENT_DENSITY={density} FILAMENT_HEAT_CAPACITY={heat_capacity}

[gcode_macro _SAF_PREHEAT_CHAMBER]
description: Preheat chamber based on filament type, with VOC ventilation if needed
variable_filament_table:
    {   ## (temp, time, voc)
        "PLA"        : (30, 0, False),
        "PETG"       : (40, 0, False),
        "PC+ABS"     : (60, 10, True),
        "ABS"        : (55, 10, True),
        "ASA"        : (55, 10, True),
        "PA6"        : (50, 10, True),
        "PA"         : (50, 10, True),
        "PC"         : (60, 10, True),
        "TPU"        : (40, 0, False),
        "TPU-90A"    : (40, 0, False),
        "TPU-95A"    : (40, 0, False),
        "ABS-CF"     : (55, 10, True),
        "ASA-CF"     : (55, 10, True),
        "PA6-CF"     : (50, 10, True),
        "PC+ABS-CF"  : (60, 10, True),
        "PC+CF"      : (60, 10, True),
        "PLA-CF"     : (30, 0, False),
        "PETG-CF"    : (40, 0, False)
    }
gcode:
    {% set filament = params.MATERIAL|default("PLA")|upper %}
    {% set temp, timeout, voc = filament_table.get(filament, filament_table["PLA"]) %}

    RESPOND PREFIX="üå°Ô∏è" MSG="Preheating chamber for {filament}: target {temp}¬∞C, timeout {timeout} min, VOC={voc}"

    {% if printer.toolhead.position.z < 100 %}
        G0 Z220 F15000
        RESPOND PREFIX="‚¨ÜÔ∏è" MSG="Moving Z to 220 mm"
    {% endif %}

    {% if voc %}
        SET_FAN_SPEED FAN=chamber SPEED=1.0
        RESPOND PREFIX="üí®" MSG="VOC ventilation ON"
    {% endif %}

    {% if temp > 0 %}
        SET_FAN_SPEED FAN=auxiliary_1 SPEED=1.0
        SET_FAN_SPEED FAN=auxiliary_2 SPEED=1.0
        RESPOND PREFIX="üåÄ" MSG="Auxiliary fans ON"

        {% if timeout > 0 %}
            {% set total_seconds = timeout * 60 %}
            {% set total_mins = total_seconds // 60 %}
            {% set total_secs = total_seconds % 60 %}
            RESPOND PREFIX="‚è≥" MSG="Waiting up to {total_mins} min {total_secs} sec for chamber to reach {temp}¬∞C"

            {% set intervals = total_seconds // 15 %}
            {% set leftover = total_seconds % 15 %}

            {% for i in range(intervals) %}
                G4 P15000
                {% set remaining_time = total_seconds - ((i + 1) * 15) %}
                {% if remaining_time > 0 %}
                    {% set mins = remaining_time // 60 %}
                    {% set secs = remaining_time % 60 %}
                    RESPOND PREFIX="‚åõ" MSG="{mins} min {secs} sec remaining..."
                {% endif %}
            {% endfor %}

            {% if leftover > 0 %}
                G4 P{ leftover * 1000 }
            {% endif %}
        {% endif %}

        RESPOND PREFIX="‚úÖ" MSG="Chamber preheat complete!"
        SET_FAN_SPEED FAN=auxiliary_1 SPEED=0
        SET_FAN_SPEED FAN=auxiliary_2 SPEED=0
        RESPOND PREFIX="üõë" MSG="Auxiliary fans OFF"
    {% else %}
        RESPOND PREFIX="‚ùå" MSG="No preheat required for {filament}"
    {% endif %}

[gcode_macro _SAF_COOLDOWN_CHAMBER]
description: Cool down nozzle and vent VOCs after print, with controlled fans and wait
variable_filament_table:
    {   ## (VOC, part_speed)
        "PLA"        : (False, 1.0),
        "PETG"       : (False, 1.0),
        "PC+ABS"     : (True, 0.5),
        "ABS"        : (True, 0.5),
        "ASA"        : (True, 0.5),
        "PA6"        : (True, 0.3),
        "PA"         : (True, 0.3),
        "PC"         : (True, 0.5),
        "TPU"        : (False, 1.0),
        "TPU-90A"    : (False, 1.0),
        "TPU-95A"    : (False, 1.0),
        "ABS-CF"     : (True, 0.5),
        "ASA-CF"     : (True, 0.5),
        "PA6-CF"     : (True, 0.3),
        "PC+ABS-CF"  : (True, 0.5),
        "PC+CF"      : (True, 0.5),
        "PLA-CF"     : (False, 1.0),
        "PETG-CF"    : (False, 1.0)
    }
gcode:
    {% set filament = params.MATERIAL|default("PLA")|upper %}
    {% set voc, part_speed = filament_table.get(filament, filament_table["PLA"]) %}

    RESPOND PREFIX="‚ùÑÔ∏è" MSG="Starting cooldown sequence for {filament}"

    {% if printer.toolhead.position.z < 100 %}
        G0 Z200 F15000
        RESPOND PREFIX="‚¨ÜÔ∏è" MSG="Moving Z to 200 mm"
    {% endif %}

    SET_FAN_SPEED FAN=part SPEED={part_speed}
    RESPOND PREFIX="üåÄ" MSG="Fans set: part={part_speed*100}%"

    M109 S150 
    M104 S0
    RESPOND PREFIX="üå°Ô∏è" MSG="Nozzle cooled to 150¬∞C and now turned off"

    SET_FAN_SPEED FAN=part SPEED=0
    RESPOND PREFIX="üõë" MSG="Fans OFF"

    {% if voc %}
        SET_FAN_SPEED FAN=chamber SPEED=1.0
        RESPOND PREFIX="üí®" MSG="VOC ventilation ON for 10 min"
        G4 P600000  ; 10 minutes vent
        RESPOND PREFIX="‚úÖ" MSG="VOC venting complete"
    {% endif %}

    RESPOND PREFIX="üéâ" MSG="Cooldown complete"

[gcode_macro FILAMENT_DRYER]
description: Dry filament by setting bed temperature and optional duration based on filament type
variable_dryer_table:
    {   ## (Temp(bed), Time(hour))
        "PLA"     : (55, 8),
        "PLA-CF"  : (55, 8),
        "PETG"    : (65, 8),
        "ABS"     : (75, 8),
        "ASA"     : (75, 8),
        "PC"      : (90, 8),
        "TPU"     : (70, 8),
        "PA"      : (85, 8),
        "PA-CF"   : (85, 8)
    }
gcode:
    {% set filament = params.MATERIAL|default("PLA")|upper %}
    {% set temp, default_hours = dryer_table.get(filament, dryer_table["PLA"]) %}
    {% set hours = params.TIME_HOURS|default(default_hours)|float %}
    {% set total_seconds = (hours * 3600)|int %}

    RESPOND PREFIX="üå°Ô∏è" MSG="Drying filament {filament} at {temp}¬∞C for {hours} hour(s)"

    M140 S{temp}

    {% if printer.toolhead.position.z < 100 %}
        G0 Z100 F15000
        RESPOND PREFIX="‚¨ÜÔ∏è" MSG="Lifting Z to 100 mm for safe drying"
    {% endif %}

    SET_FAN_SPEED FAN=auxiliary_1 SPEED=1.0
    SET_FAN_SPEED FAN=auxiliary_2 SPEED=1.0
    RESPOND PREFIX="üåÄ" MSG="Auxiliary fans ON"

    {% set full_minutes = total_seconds // 60 %}
    {% set leftover = total_seconds % 60 %}

    {% for i in range(full_minutes) %}
        {% set remaining = total_seconds - (i * 60) %}
        {% set mins = remaining // 60 %}
        {% set secs = remaining % 60 %}
        RESPOND PREFIX="‚åõ" MSG="Time remaining: {mins} min {secs} sec"
        G4 P60000
    {% endfor %}

    {% if leftover > 0 %}
        RESPOND PREFIX="‚åõ" MSG="Time remaining: 0 min {leftover} sec"
        G4 P{ leftover * 1000 }
    {% endif %}

    RESPOND PREFIX="‚úÖ" MSG="Drying complete for {filament}"
    M140 S0
    SET_FAN_SPEED FAN=auxiliary_1 SPEED=0
    SET_FAN_SPEED FAN=auxiliary_2 SPEED=0
    RESPOND PREFIX="üõë" MSG="Auxiliary fans OFF"