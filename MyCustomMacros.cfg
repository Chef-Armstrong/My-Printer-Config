[gcode_macro _SAF_PREHEAT_CHAMBER]
description: Preheat chamber based on filament type, with VOC ventilation if needed
variable_filament_table:
    {   ## (temp, time, voc)
        "PLA"        : (30, 0, False),
        "PETG"       : (40, 0, False),
        "PC+ABS"     : (60, 10, True),
        "ABS"        : (55, 10, True),
        "ASA"        : (55, 10, True),
        "PA6"        : (50, 10, True),
        "PA"         : (50, 10, True),
        "PC"         : (60, 10, True),
        "TPU"        : (40, 0, False),
        "TPU-90A"    : (40, 0, False),
        "TPU-95A"    : (40, 0, False),
        "ABS-CF"     : (55, 10, True),
        "ASA-CF"     : (55, 10, True),
        "PA6-CF"     : (50, 10, True),
        "PC+ABS-CF"  : (60, 10, True),
        "PC+CF"      : (60, 10, True),
        "PLA-CF"     : (30, 0, False),
        "PETG-CF"    : (40, 0, False)
    }
gcode:
    {% set filament = params.MATERIAL|default("PLA")|upper %}
    {% set temp, timeout, voc = filament_table.get(filament, filament_table["PLA"]) %}

    RESPOND PREFIX="üå°Ô∏è" MSG="Preheating chamber for {filament}: target {temp}¬∞C, timeout {timeout} min, VOC={voc}"

    {% if printer.toolhead.position.z < 100 %}
        G0 Z100 F15000
        RESPOND PREFIX="‚¨ÜÔ∏è" MSG="Moving Z to 100 mm"
    {% endif %}

    {% if voc %}
        SET_FAN_SPEED FAN=chamber SPEED=1.0
        RESPOND PREFIX="üí®" MSG="VOC ventilation ON"
    {% endif %}

    {% if temp > 0 %}
        SET_FAN_SPEED FAN=auxiliary_1 SPEED=1.0
        SET_FAN_SPEED FAN=auxiliary_2 SPEED=1.0
        RESPOND PREFIX="üåÄ" MSG="Auxiliary fans ON"

        {% if timeout > 0 %}
            {% set total_seconds = timeout * 60 %}
            {% set total_mins = total_seconds // 60 %}
            {% set total_secs = total_seconds % 60 %}
            RESPOND PREFIX="‚è≥" MSG="Waiting up to {total_mins} min {total_secs} sec for chamber to reach {temp}¬∞C"

            {% set intervals = total_seconds // 15 %}
            {% set leftover = total_seconds % 15 %}

            {% for i in range(intervals) %}
                G4 P15000
                {% set remaining_time = total_seconds - ((i + 1) * 15) %}
                {% if remaining_time > 0 %}
                    {% set mins = remaining_time // 60 %}
                    {% set secs = remaining_time % 60 %}
                    RESPOND PREFIX="‚åõ" MSG="{mins} min {secs} sec remaining..."
                {% endif %}
            {% endfor %}

            {% if leftover > 0 %}
                G4 P{ leftover * 1000 }
            {% endif %}
        {% endif %}

        RESPOND PREFIX="‚úÖ" MSG="Chamber preheat complete!"
        SET_FAN_SPEED FAN=auxiliary_1 SPEED=0
        SET_FAN_SPEED FAN=auxiliary_2 SPEED=0
        RESPOND PREFIX="üõë" MSG="Auxiliary fans OFF"
    {% else %}
        RESPOND PREFIX="‚ùå" MSG="No preheat required for {filament}"
    {% endif %}

[gcode_macro _SAF_COOLDOWN_CHAMBER]
description: Cool down nozzle and vent VOCs after print, with controlled fans and wait
variable_filament_table:
    {   ## (VOC, aux_fan_speed, part_speed)
        "PLA"        : (False, 1.0, 1.0),
        "PETG"       : (False, 1.0, 1.0),
        "PC+ABS"     : (True, 0.5, 0.5),
        "ABS"        : (True, 0.5, 0.5),
        "ASA"        : (True, 0.5, 0.5),
        "PA6"        : (True, 0.3, 0.3),
        "PA"         : (True, 0.3, 0.3),
        "PC"         : (True, 0.5, 0.5),
        "TPU"        : (False, 1.0, 1.0),
        "TPU-90A"    : (False, 1.0, 1.0),
        "TPU-95A"    : (False, 1.0, 1.0),
        "ABS-CF"     : (True, 0.5, 0.5),
        "ASA-CF"     : (True, 0.5, 0.5),
        "PA6-CF"     : (True, 0.3, 0.3),
        "PC+ABS-CF"  : (True, 0.5, 0.5),
        "PC+CF"      : (True, 0.5, 0.5),
        "PLA-CF"     : (False, 1.0, 1.0),
        "PETG-CF"    : (False, 1.0, 1.0)
    }
gcode:
    {% set filament = params.MATERIAL|default("PLA")|upper %}
    {% set voc, aux_speed, part_speed = filament_table.get(filament, filament_table["PLA"]) %}

    RESPOND PREFIX="‚ùÑÔ∏è" MSG="Starting cooldown sequence for {filament}"

    {% if printer.toolhead.position.z < 230 %}
        G0 Z230 F15000
        RESPOND PREFIX="‚¨ÜÔ∏è" MSG="Moving Z to 230 mm"
    {% endif %}

    SET_FAN_SPEED FAN=auxiliary_1 SPEED={aux_speed}
    SET_FAN_SPEED FAN=auxiliary_2 SPEED={aux_speed}
    SET_FAN_SPEED FAN=part SPEED={part_speed}
    RESPOND PREFIX="üåÄ" MSG="Fans set: auxiliary={aux_speed*100}%, part={part_speed*100}%"

    M109 S150 
    M104 S0
    RESPOND PREFIX="üå°Ô∏è" MSG="Nozzle cooled to 150¬∞C and now turned off"

    SET_FAN_SPEED FAN=auxiliary_1 SPEED=0
    SET_FAN_SPEED FAN=auxiliary_2 SPEED=0
    SET_FAN_SPEED FAN=part SPEED=0
    RESPOND PREFIX="üõë" MSG="Fans OFF"

    {% if voc %}
        SET_FAN_SPEED FAN=chamber SPEED=1.0
        RESPOND PREFIX="üí®" MSG="VOC ventilation ON for 10 min"
        G4 P600000  ; 10 minutes vent
        RESPOND PREFIX="‚úÖ" MSG="VOC venting complete"
    {% endif %}

    RESPOND PREFIX="üéâ" MSG="Cooldown complete"

[gcode_macro FILAMENT_DRYER]
description: Dry filament by setting bed temperature and optional duration based on filament type
variable_dryer_table:
    {   ## (Temp(bed), Time(hour))
        "PLA"     : (55, 8),
        "PLA-CF"  : (55, 8),
        "PETG"    : (65, 8),
        "ABS"     : (75, 8),
        "ASA"     : (75, 8),
        "PC"      : (90, 8),
        "TPU"     : (70, 8),
        "PA"      : (85, 8),
        "PA-CF"   : (85, 8)
    }
gcode:
    {% set filament = params.MATERIAL|default("PLA")|upper %}
    {% set temp, default_hours = dryer_table.get(filament, dryer_table["PLA"]) %}
    {% set hours = params.TIME_HOURS|default(default_hours)|float %}
    {% set total_seconds = (hours * 3600)|int %}

    RESPOND PREFIX="üå°Ô∏è" MSG="Drying filament {filament} at {temp}¬∞C for {hours} hour(s)"

    M140 S{temp}

    {% if printer.toolhead.position.z < 100 %}
        G0 Z100 F15000
        RESPOND PREFIX="‚¨ÜÔ∏è" MSG="Lifting Z to 100 mm for safe drying"
    {% endif %}

    SET_FAN_SPEED FAN=auxiliary_1 SPEED=1.0
    SET_FAN_SPEED FAN=auxiliary_2 SPEED=1.0
    RESPOND PREFIX="üåÄ" MSG="Auxiliary fans ON"

    {% set full_minutes = total_seconds // 60 %}
    {% set leftover = total_seconds % 60 %}

    {% for i in range(full_minutes) %}
        {% set remaining = total_seconds - (i * 60) %}
        {% set mins = remaining // 60 %}
        {% set secs = remaining % 60 %}
        RESPOND PREFIX="‚åõ" MSG="Time remaining: {mins} min {secs} sec"
        G4 P60000
    {% endfor %}

    {% if leftover > 0 %}
        RESPOND PREFIX="‚åõ" MSG="Time remaining: 0 min {leftover} sec"
        G4 P{ leftover * 1000 }
    {% endif %}

    RESPOND PREFIX="‚úÖ" MSG="Drying complete for {filament}"
    M140 S0
    SET_FAN_SPEED FAN=auxiliary_1 SPEED=0
    SET_FAN_SPEED FAN=auxiliary_2 SPEED=0
    RESPOND PREFIX="üõë" MSG="Auxiliary fans OFF"